import{d as O,x as E,c as p,a,F as U,t as F,k as x,A as M,D as P,r as C,o as _,_ as N,p as le,i as ue,b as T,u as re,n as k,G as de,h as ce,s as ve}from"./index-DKTBb0-q.js";import{u as me,C as fe,a as pe}from"./useCanvasElements-B35NXuy8.js";import{u as _e}from"./canvas.store-gBLLoiNg.js";const ge={class:"mst-canvas-options"},he={key:0,class:"mst-canvas-options__name-display"},Ce={class:"mst-canvas-options__group"},be={class:"mst-canvas-options__group"},ye={class:"mst-canvas-options__row"},ke=["checked"],we={class:"mst-canvas-options__group"},Ee={class:"mst-canvas-options__row"},xe=["checked"],Se={class:"mst-canvas-options__group"},De={class:"mst-canvas-options__image-row"},Ie={class:"mst-canvas-options__file-trigger"},Ve=["src"],Ae={class:"mst-canvas-options__group"},Be={class:"mst-canvas-options__color-row"},Fe={class:"mst-canvas-options__color-value"},Te={class:"mst-canvas-options__group"},Ue=["disabled"],Me=O({__name:"CanvasOptionsPanel",props:{meta:{},readOnly:{type:Boolean},saving:{type:Boolean}},emits:["update:meta","save","delete"],setup(u,{emit:b}){const h=u,n=b,r=C(""),v=C(!1),m=C(!1),l=C("#ffffff");E(()=>h.meta,o=>{o&&(r.value=o.name??"",v.value=!!o.isFavorite,m.value=!!o.isPublic,l.value=o.backgroundColor??"#ffffff")},{immediate:!0});function g(){const o=r.value.trim();n("update:meta",{name:o||"Untitled"})}function f(o){const t=o.target;v.value=t.checked,n("update:meta",{isFavorite:t.checked})}function S(o){const t=o.target;m.value=t.checked,n("update:meta",{isPublic:t.checked})}function D(){g(),n("save")}function I(o){const t=o.target,d=t.files?.[0];if(!d||!d.type.startsWith("image/"))return;const y=new FileReader;y.onload=()=>{const B=y.result;n("update:meta",{previewImage:B})},y.readAsDataURL(d),t.value=""}function V(o){const t=o.target;l.value=t.value,n("update:meta",{backgroundColor:t.value})}function A(){confirm("Delete this canvas? This cannot be undone.")&&n("delete")}return(o,t)=>(_(),p("aside",ge,[t[10]||(t[10]=a("h3",{class:"mst-canvas-options__title"},"Options",-1)),u.readOnly?(_(),p(U,{key:0},[t[2]||(t[2]=a("p",{class:"mst-canvas-options__readonly"},"View only — you cannot edit this canvas.",-1)),u.meta?(_(),p("p",he,F(u.meta.name),1)):x("",!0)],64)):(_(),p(U,{key:1},[a("div",Ce,[t[3]||(t[3]=a("label",{class:"mst-canvas-options__label"},"Canvas name",-1)),M(a("input",{"onUpdate:modelValue":t[0]||(t[0]=d=>r.value=d),type:"text",class:"mst-canvas-options__input",placeholder:"Untitled",onBlur:g},null,544),[[P,r.value]])]),a("div",be,[a("label",ye,[a("input",{checked:v.value,type:"checkbox",onChange:f},null,40,ke),t[4]||(t[4]=a("span",null,"Favorite",-1))])]),a("div",we,[a("label",Ee,[a("input",{checked:m.value,type:"checkbox",onChange:S},null,40,xe),t[5]||(t[5]=a("span",null,"Public",-1))])]),a("div",Se,[t[7]||(t[7]=a("label",{class:"mst-canvas-options__label"},"Background image",-1)),a("div",De,[a("label",Ie,[a("input",{type:"file",accept:"image/*",class:"mst-canvas-options__file",onChange:I},null,32),t[6]||(t[6]=a("span",{class:"mst-canvas-options__file-text"},"Choose image",-1))]),u.meta?.previewImage?(_(),p("img",{key:0,src:u.meta.previewImage,alt:"Preview",class:"mst-canvas-options__preview"},null,8,Ve)):x("",!0)])]),a("div",Ae,[t[8]||(t[8]=a("label",{class:"mst-canvas-options__label"},"Background color",-1)),a("div",Be,[M(a("input",{"onUpdate:modelValue":t[1]||(t[1]=d=>l.value=d),type:"color",class:"mst-canvas-options__color",onInput:V},null,544),[[P,l.value]]),a("span",Fe,F(l.value),1)])]),a("div",Te,[a("button",{type:"button",class:"mst-canvas-options__save",disabled:u.saving,onClick:D},F(u.saving?"Saving…":"Save"),9,Ue)]),a("div",{class:"mst-canvas-options__group"},[a("button",{type:"button",class:"mst-canvas-options__delete",onClick:A}," Delete canvas ")]),t[9]||(t[9]=a("p",{class:"mst-canvas-options__hint"},"Changes are saved only when you click Save.",-1))],64))]))}}),Pe=N(Me,[["__scopeId","data-v-c7c39a01"]]),Oe={class:"mst-canvas-editor"},Ne={key:0,class:"mst-canvas-editor__loading"},Re={key:1,class:"mst-canvas-editor__readonly-banner"},$e={class:"mst-canvas-editor__body"},ze=O({__name:"CanvasEditorView",setup(u){const b=ve(),h=ce(),n=_e(),r=le(),v=C(!1),m=C(null),l=k(()=>b.name==="canvas-editor"?b.params.id:void 0),g=k(()=>b.name==="canvas-new"||l.value==="new"),{elements:f,updatePosition:S,updateSize:D,updateText:I,updateList:V,updateTask:A,updateImage:o,updateAudio:t,updateVideo:d,updateDate:y,removeElement:B,addConnection:R,addElement:$}=me([]),w=k(()=>n.currentCanvas?.meta??null),z=k(()=>{const e=w.value;if(!e)return!1;if(n.allCanvases.some(ie=>ie.id===e.id))return!0;const c=r.user?.id;return e.owner==null?!0:c==null?!1:String(e.owner)===String(c)}),s=k(()=>!z.value);async function L(){if(g.value){n.clearCurrentCanvas();try{const e=await n.createCanvas("Untitled");await h.replace({name:"canvas-editor",params:{id:String(e.id)}})}catch{await h.replace({name:"dashboard",query:{error:"create-failed"}})}}}async function q(){const e=l.value;if(!e||g.value)return;const i=n.currentCanvas;if(i?.meta?.id===e){f.value=[...i.elements??[]];return}n.allCanvases.length===0&&await n.loadCanvases();const c=await n.loadCanvas(e);if(!c){await h.replace({name:"dashboard"});return}f.value=[...c.elements]}E(g,e=>{e&&L()},{immediate:!0}),E(l,()=>{!g.value&&l.value&&q()},{immediate:!0}),ue(async()=>{!r.user&&r.isAuthenticated&&await r.refreshUser()}),E(f,e=>{s.value||n.setCurrentElements([...e])},{deep:!0});function G(e){if(s.value)return;const i=f.value.find(c=>c.id===e.id);i&&S(e.id,{...i.position,x:e.x,y:e.y})}function W(e){if(s.value)return;const i=f.value.find(c=>c.id===e.id);i&&D(e.id,{...i.size,x:e.width,y:e.height})}function j(e){s.value||I(e.id,e.text)}function H(e){s.value||V(e.id,e.listData)}function J(e){s.value||A(e.id,e.data,e.checked)}function K(e){s.value||o(e.id,e.base64File)}function Q(e){s.value||t(e.id,e.base64File)}function X(e){s.value||d(e.id,e.url)}function Y(e){s.value||y(e.id,e.date,e.data)}function Z(e){s.value||B(e)}function ee(e){s.value||R(e.self,e.target)}function te(e){s.value||($(e.type,e.x,e.y),m.value=null)}function ae(e){m.value=e}function ne(e){s.value||n.setCurrentMeta(e)}async function se(){if(!s.value){v.value=!0,await de();try{await n.saveCurrentCanvas()}finally{v.value=!1}}}async function oe(){const e=n.currentCanvas?.meta;e?.id&&(await n.deleteCanvas(e.id),h.replace({name:"dashboard"}))}return(e,i)=>(_(),p("div",Oe,[v.value?(_(),p("div",Ne,[...i[0]||(i[0]=[a("div",{class:"mst-canvas-editor__loading-spinner"},null,-1),a("p",{class:"mst-canvas-editor__loading-text"},"Saving canvas…",-1)])])):x("",!0),s.value?(_(),p("div",Re," View only — you're viewing someone else's canvas ")):x("",!0),a("div",$e,[T(fe,{"read-only":s.value,"selected-add-type":m.value,"onUpdate:selectedAddType":ae},null,8,["read-only","selected-add-type"]),T(pe,{elements:re(f),"read-only":s.value,"background-image":w.value?.previewImage??null,"background-color":w.value?.backgroundColor??null,"selected-add-type":m.value,onMove:G,onResize:W,onEdit:j,"onEdit:list":H,"onEdit:task":J,"onEdit:image":K,"onEdit:audio":Q,"onEdit:video":X,"onEdit:date":Y,onDelete:Z,onConnect:ee,onAdd:te},null,8,["elements","read-only","background-image","background-color","selected-add-type"])]),T(Pe,{meta:w.value,"read-only":s.value,saving:v.value,"onUpdate:meta":ne,onSave:se,onDelete:oe},null,8,["meta","read-only","saving"])]))}}),We=N(ze,[["__scopeId","data-v-f04c0dc2"]]);export{We as default};
