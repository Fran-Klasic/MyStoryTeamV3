import{C as oe,p as ae,r as g,n as R,d as re,i as ie,j as le,x as G,c as u,a as o,v as P,u as i,k as E,F as V,y as ee,A as Q,D as J,E as se,t as w,m as X,f as O,s as ue,o as c,G as ce,_ as de}from"./index-Y4iv2t5t.js";import{g as Z,a as me,b as te,u as ve,c as ne,d as ge,s as fe}from"./user.service-BCfMvjXU.js";import{a as _e}from"./useMediaQuery-D8EDB1oz.js";const pe=2500,he=oe("message",()=>{const C=ae(),b=g([]),f=g(null),n=g([]),m=g(!1),I=g(!1),p=g(null);let h=null;const _=new Map,v=new Map,D=new Map,y=g({}),k=R(()=>{const e=f.value;return e?b.value.find(s=>s.id===e)??null:null}),S=R(()=>{const e=k.value;if(!e)return null;const s=e.otherUserId,a=C.user?.id,r=v.get(e.id);return r||(s&&a&&String(s)!==String(a)?s:s||null)});function $(e,s){const a=s[s.length-1];a&&_.set(e,{content:a.content,createdAt:a.createdAt})}function B(e){return _.get(e)}async function F(e){const s=C.user?.id;if(s&&String(e)===String(s))return C.user?.username??"You";const a=D.get(e);if(a)return a;const r=parseInt(e,10);if(Number.isNaN(r))return`User#${e}`;const l=await Z(r);return l?(D.set(e,l),l):`User#${e}`}function W(){f.value=null,U()}function U(){h&&(clearInterval(h),h=null)}function j(e){U(),h=setInterval(async()=>{if(f.value===e)try{const s=await ne(e);if(f.value===e){n.value=s,$(e,s);const a=C.user?.id;if(a&&s.length>0){const r=s.find(l=>String(l.senderId)!==String(a));r&&v.set(e,String(r.senderId))}}}catch{}},pe)}async function H(){m.value=!0;try{b.value=await me();const e={},s=C.user?.id;await Promise.all(b.value.map(async a=>{const r=await te(a.id);if(r){e[a.id]=r;return}const l=a.otherUserId;if(l&&s&&String(l)!==String(s)){const d=await Z(parseInt(l,10));d&&(e[a.id]=d)}})),y.value={...e}}finally{m.value=!1}}function Y(e,s){return y.value[e]??s}async function q(e,s){const a=await ve(e,s);return a&&(y.value={...y.value,[e]:s.trim()}),a}async function x(e){m.value=!0;try{const s=await ne(e);n.value=s,$(e,s);const a=C.user?.id;if(a&&s.length>0){const r=s.find(l=>String(l.senderId)!==String(a));r&&v.set(e,String(r.senderId))}for(const r of s)await F(r.senderId)}finally{m.value=!1}}async function T(e){if(!(!e||e.trim()==="")){if(U(),f.value=e,await x(e),!y.value[e]){let s=await te(e);if(!s){const a=v.get(e),r=b.value.find(d=>d.id===e),l=a??(r&&String(r.otherUserId)!==String(C.user?.id)?r.otherUserId:null);if(l){const d=await Z(parseInt(l,10));d&&(s=d)}}s&&(y.value={...y.value,[e]:s})}j(e)}}async function L(e){m.value=!0;try{const s=await ge(e);return s>0?(await H(),String(s)):null}finally{m.value=!1}}async function K(e){const s=f.value,a=C.user?.id;let r=S.value;if((!r||r===a)&&(r=v.get(s??"")??r??null),!s||!a||!e.trim())return!1;if(!r)return p.value="Could not determine conversation recipient.",!1;p.value=null;const l=e.trim(),d=`temp-${Date.now()}`,M={id:d,conversationId:s,senderId:a,content:l,createdAt:new Date().toISOString()};n.value=[...n.value,M],I.value=!0;try{return await fe(s,parseInt(a,10),parseInt(r,10),l)>0?(await x(s),!0):(n.value=n.value.filter(z=>z.id!==d),p.value="Could not send message.",!1)}catch{return n.value=n.value.filter(N=>N.id!==d),p.value="Could not send message.",!1}finally{I.value=!1}}function A(e){const s=e.trim();if(!s)return[];const a=s.split(",").map(l=>l.trim()).filter(Boolean),r=[];for(const l of a){const d=l.indexOf("#"),M=d>=0?l.slice(d+1).trim():l,N=parseInt(M,10);!Number.isNaN(N)&&N>0&&r.push(N)}return[...new Set(r)]}async function t(e){const s=C.user?.id;if(!s)return null;const a=A(e);if(a.length===0)return null;const r=[parseInt(s,10),...a],l=[...new Set(r)],d=b.value.find(N=>a.some(z=>String(z)===N.otherUserId));if(d&&a.length===1)return v.set(d.id,String(a[0])),await T(d.id),d.id;const M=await L(l);return M?(a.length>0&&v.set(M,String(a[0])),await T(M),M):null}return{conversations:b,currentConversationId:f,messages:n,loading:m,sending:I,sendError:p,currentConversation:k,otherUserId:S,loadConversations:H,loadMessages:x,selectConversation:T,createConversation:L,sendMessage:K,startConversationWith:t,parseUsernameIdInput:A,stopPolling:U,backToConversations:W,getLastMessagePreview:B,getUsernameForSender:F,getConversationDisplayName:Y,updateConversationName:q}}),ye={class:"mst-messages"},we={key:0,class:"mst-messages__loading"},Ce={key:1,class:"mst-messages__empty"},be=["onClick"],Ie={class:"mst-messages__item-name"},ke={class:"mst-messages__item-preview"},Se={key:0,class:"mst-messages__placeholder"},Me={key:1,class:"mst-messages__thread"},Ne={class:"mst-messages__thread-header"},Ue={class:"mst-messages__thread-name"},xe={class:"mst-messages__thread-content"},De={key:0,class:"mst-messages__loading"},Be={key:1,class:"mst-messages__empty-thread"},Te={class:"mst-messages__bubble-username"},Le={class:"mst-messages__bubble-content"},Ae={class:"mst-messages__bubble-time"},Pe={class:"mst-messages__compose-row"},Ee=["disabled"],Ve=["disabled"],$e={key:0,class:"mst-messages__send-error"},Fe={class:"mst-messages__modal"},He=["disabled"],Ye={key:0,class:"mst-messages__modal-error"},Oe={class:"mst-messages__modal-actions"},Re=["disabled"],We=["disabled"],je=re({__name:"MessagesView",setup(C){const b=ue(),f=_e("(max-width: 768px)"),n=he(),m=ae(),I=g(""),p=g(!1),h=g(""),_=g(""),v=g(!1),D=g(null),y=g({}),k=g(null),S=g(""),$=R(()=>m.user?.id??null),B=R(()=>{const t=[...n.conversations];return t.sort((e,s)=>new Date(s.createdAt).getTime()-new Date(e.createdAt).getTime()),t});function F(t){const e=new Date(t),a=new Date().getTime()-e.getTime();return a<864e5?e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):a<1728e5?"Yesterday":e.toLocaleDateString()}function W(t){return new Date(t).toLocaleDateString([],{month:"short",day:"numeric",year:new Date(t).getFullYear()!==new Date().getFullYear()?"numeric":void 0})}function U(t,e=40){return t.length<=e?t:t.slice(0,e).trim()+"…"}function j(t){return t===$.value}function H(t){return y.value[t]??`User#${t}`}function Y(t){return n.getConversationDisplayName(t.id,"Conversation")}function q(){const t=n.currentConversationId,e=n.currentConversation;if(!t||!e)return;const s=n.getConversationDisplayName(t,"Conversation");k.value=t,S.value=s}async function x(){const t=k.value,e=S.value.trim();if(!t||!e){k.value=null;return}const s=await n.updateConversationName(t,e);k.value=null,s||(S.value="")}async function T(t){await n.selectConversation(t)}async function L(){const t=I.value.trim();if(!t||n.sending)return;await n.sendMessage(t)&&(I.value="")}function K(){p.value=!0,h.value="",_.value=""}async function A(){const t=h.value.trim();if(!t)return;if(!m.isAuthenticated){_.value="You must be signed in to start a conversation.";return}if(!m.user?.id){v.value=!0,_.value="";try{await m.refreshUser()}finally{v.value=!1}if(!m.user?.id){_.value="Could not load your profile. Please refresh the page.";return}}if(n.parseUsernameIdInput(t).length===0){_.value="Invalid format. Use username#id (e.g. test#1)";return}_.value="",v.value=!0;try{await n.startConversationWith(t)?(p.value=!1,h.value=""):_.value="Could not create conversation. Check the user ID exists."}finally{v.value=!1}}return ie(async()=>{m.isAuthenticated&&!m.user?.id&&await m.refreshUser(),await n.loadConversations();const t=b.query.userId;typeof t=="string"&&t&&await n.startConversationWith(t)}),le(()=>{n.stopPolling()}),G(()=>b.query.userId,async t=>{typeof t=="string"&&t&&await n.startConversationWith(t)}),G(()=>n.messages,()=>{ce(()=>{const t=D.value;if(!t)return;t.scrollHeight-t.scrollTop-t.clientHeight<100&&t.scrollTo({top:t.scrollHeight,behavior:"smooth"})})},{flush:"post"}),G(()=>n.messages,async()=>{const t=n.messages,e=[...new Set(t.map(a=>a.senderId))],s={...y.value};for(const a of e)s[a]||(s[a]=await n.getUsernameForSender(a));y.value=s},{immediate:!0}),(t,e)=>(c(),u("div",ye,[e[10]||(e[10]=o("header",{class:"mst-messages__header"},[o("h1",{class:"mst-messages__title"},"Messages"),o("p",{class:"mst-messages__subtitle"},"Direct messages with other users.")],-1)),o("div",{class:P(["mst-messages__layout",{"mst-messages__layout--mobile":i(f),"mst-messages__layout--mobile-thread":i(f)&&i(n).currentConversationId}])},[o("aside",{class:P(["mst-messages__list",{"mst-messages__list--hidden":i(f)&&i(n).currentConversationId}])},[o("button",{type:"button",class:"mst-messages__new-btn",onClick:K}," + New message "),i(n).loading&&B.value.length===0?(c(),u("p",we," Loading conversations… ")):B.value.length===0?(c(),u("p",Ce," No conversations yet. ")):E("",!0),(c(!0),u(V,null,ee(B.value,s=>(c(),u("button",{key:s.id,type:"button",class:P(["mst-messages__item",{"mst-messages__item--active":i(n).currentConversationId===s.id}]),onClick:a=>T(s.id)},[o("span",Ie,w(Y(s)),1),o("span",ke,[i(n).getLastMessagePreview(s.id)?(c(),u(V,{key:0},[O(w(U(i(n).getLastMessagePreview(s.id).content)),1)],64)):(c(),u(V,{key:1},[O(w(W(s.createdAt)),1)],64))])],10,be))),128))],2),o("main",{class:P(["mst-messages__panel",{"mst-messages__panel--hidden":i(f)&&!i(n).currentConversationId}])},[i(n).currentConversationId?(c(),u("div",Me,[o("header",Ne,[i(f)?(c(),u("button",{key:0,type:"button",class:"mst-messages__back-btn","aria-label":"Back to conversations",onClick:e[0]||(e[0]=(...s)=>i(n).backToConversations&&i(n).backToConversations(...s))},[...e[6]||(e[6]=[o("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[o("path",{d:"M19 12H5M12 19l-7-7 7-7"})],-1)])])):E("",!0),k.value===i(n).currentConversationId?Q((c(),u("input",{key:1,"onUpdate:modelValue":e[1]||(e[1]=s=>S.value=s),type:"text",class:"mst-messages__thread-name-input",placeholder:"Conversation name",onBlur:x,onKeydown:se(x,["enter"])},null,544)),[[J,S.value]]):(c(),u(V,{key:2},[o("span",Ue,w(i(n).currentConversation&&Y(i(n).currentConversation)),1),o("button",{type:"button",class:"mst-messages__thread-edit",title:"Edit conversation name",onClick:q},[...e[7]||(e[7]=[o("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[o("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),o("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})],-1)])])],64))]),o("div",xe,[i(n).loading&&i(n).messages.length===0?(c(),u("p",De," Loading messages… ")):i(n).messages.length===0?(c(),u("p",Be," No messages yet. Start the conversation! ")):(c(),u("div",{key:2,ref_key:"messagesContainerRef",ref:D,class:"mst-messages__messages"},[(c(!0),u(V,null,ee(i(n).messages,s=>(c(),u("div",{key:s.id,class:P(["mst-messages__bubble",{"mst-messages__bubble--own":j(s.senderId)}])},[o("span",Te,w(H(s.senderId)),1),o("span",Le,w(s.content),1),o("span",Ae,w(F(s.createdAt)),1)],2))),128))],512))]),o("form",{class:"mst-messages__compose",onSubmit:X(L,["prevent"])},[o("div",Pe,[Q(o("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>I.value=s),type:"text",class:"mst-messages__input",placeholder:"Type a message…",maxlength:"1000",disabled:i(n).sending},null,8,Ee),[[J,I.value]]),o("button",{type:"submit",class:"mst-messages__send",disabled:!I.value.trim()||i(n).sending,onClick:X(L,["prevent"])},w(i(n).sending?"Sending…":"Send"),9,Ve)]),i(n).sendError?(c(),u("p",$e,w(i(n).sendError),1)):E("",!0)],32)])):(c(),u("p",Se," Select a conversation "))],2)],2),p.value?(c(),u("div",{key:0,class:"mst-messages__modal-overlay",onClick:e[5]||(e[5]=X(s=>p.value=!1,["self"]))},[o("div",Fe,[e[8]||(e[8]=o("h3",{class:"mst-messages__modal-title"},"New conversation",-1)),e[9]||(e[9]=o("p",{class:"mst-messages__modal-desc"},[O("Enter the user in format "),o("strong",null,"username#id"),O(" (e.g. test#1). For multiple users, separate with commas.")],-1)),Q(o("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>h.value=s),type:"text",class:"mst-messages__input",placeholder:"username#id (e.g. test#1)",disabled:v.value,onKeydown:se(A,["enter"])},null,40,He),[[J,h.value]]),_.value?(c(),u("p",Ye,w(_.value),1)):E("",!0),o("div",Oe,[o("button",{type:"button",class:"mst-messages__modal-btn mst-messages__modal-btn--secondary",disabled:v.value,onClick:e[4]||(e[4]=s=>p.value=!1)}," Cancel ",8,Re),o("button",{type:"button",class:"mst-messages__modal-btn mst-messages__modal-btn--primary",disabled:!h.value.trim()||v.value,onClick:A},w(v.value?"Starting…":"Start"),9,We)])])])):E("",!0)]))}}),Ge=de(je,[["__scopeId","data-v-b10bb940"]]);export{Ge as default};
