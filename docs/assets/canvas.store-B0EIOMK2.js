import{M as S,V as N,W as E,C as T,r as _,n as h,p as A}from"./index-DRMhAQNZ.js";const B=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;function P(e){return B.test(e)}function k(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function O(e){if(!e||typeof e!="object")return null;const t=e,n=(t.id??t.Id)!=null?String(t.id??t.Id):null,i=t.type??t.Type;if(!n||!i)return null;const s=t.position??t.Position,c=s?.x??s?.X??0,v=s?.y??s?.Y??0,m=s?.z??s?.Z??0,f=t.size??t.Size,I=f?.x??f?.X??220,x=f?.y??f?.Y??100,p=t.connections??t.Connections,d=Array.isArray(p)?p.map(u=>({self:String(u.self??u.Self??""),target:String(u.target??u.Target??"")})).filter(u=>u.self&&u.target):[],r=t.data??t.Data,y={x:c,y:v,z:m},C={x:I,y:x};switch(i){case"Text":return{id:n,type:"Text",data:typeof r=="string"?r:"New note",position:y,size:C,connections:d};case"List":const u=r&&typeof r=="object"&&"listData"in r?r.listData:r?.ListData;return{id:n,type:"List",data:{listData:Array.isArray(u)?u:["Item 1"]},position:y,size:C,connections:d};case"Task":const g=r&&typeof r=="object"?r:{};return{id:n,type:"Task",data:{data:g.data??g.Data??"New task",checked:!!(g.checked??g.Checked??!1)},position:y,size:C,connections:d};case"Image":const o=r&&typeof r=="object"?r:{};return{id:n,type:"Image",data:{base64File:o.base64File??o.Base64File??""},position:y,size:C,connections:d};case"Audio":const a=r&&typeof r=="object"?r:{};return{id:n,type:"Audio",data:{base64File:a.base64File??a.Base64File??""},position:y,size:C,connections:d};case"Video":const l=r&&typeof r=="object"?r:{};return{id:n,type:"Video",data:{url:l.url??l.Url??""},position:y,size:C,connections:d};case"Date":const b=r&&typeof r=="object"?r:{};return{id:n,type:"Date",data:{date:b.date??b.Date??new Date().toISOString().slice(0,10),data:b.data??b.Data??"Goal"},position:y,size:C,connections:d};default:return{id:n,type:"Text",data:typeof r=="string"?r:"New note",position:y,size:C,connections:d}}}function M(e){const t=new Map;for(const n of e)t.set(n.id,P(n.id)?n.id:k());return e.map(n=>{const i=t.get(n.id)??k(),s=(n.connections??[]).map(c=>({self:t.get(c.self)??c.self,target:t.get(c.target)??c.target}));return{...n,id:i,connections:s}})}async function j(){try{return(await S("/api/auth/canvas",{method:"GET"})).map(F)}catch{return U()}}function F(e){const t=e.ID_Canvas??e.iD_Canvas,n=e.ID_User??e.iD_User,i=e.Username??e.username,s=typeof i=="string"&&i.trim().length>0?i.trim():void 0,c=(e.Canvas_Name??e.canvas_Name)||"Untitled",v=e.Created_At??e.created_At??new Date().toISOString(),m=e.Updated_At??e.updated_At??v,f=e.Visibility??e.visibility??!1,I=e.Favorite??e.favorite??!1,x=e.Background_Image??e.background_Image??void 0,p=e.Background_Color??e.background_Color??void 0,d=typeof x=="string"&&x.trim().length===0?void 0:x??void 0,r=typeof p=="string"&&p.trim().length===0?void 0:p??void 0;return{id:String(t),name:c,owner:n!=null?String(n):void 0,ownerUsername:s,isFavorite:!!I,isPublic:!!f,createdAt:v,updatedAt:m,previewImage:d,backgroundColor:r,stats:{elementsCount:void 0,lastOpenedAt:void 0}}}async function z(){try{return(await S("/api/auth/canvas/public",{method:"GET"})).map(F)}catch{return[]}}async function R(e){try{const t=await S(`/api/auth/canvas/${e}`,{method:"GET"}),n=t.ID_Canvas??t.iD_Canvas??Number(e),i=t.ID_User??t.iD_User,s=t.Username??t.username,c=typeof s=="string"&&s.trim().length>0?s.trim():void 0,v=(t.Canvas_Name??t.canvas_Name)||"Untitled",m=t.Created_At??t.created_At??new Date().toISOString(),f=t.Updated_At??t.updated_At??m,I=t.Visibility??t.visibility??!1,x=t.Favorite??t.favorite??!1,p=t.Background_Image??t.background_Image??void 0,d=t.Background_Color??t.background_Color??void 0,r=typeof p=="string"&&p.trim().length===0?void 0:p??void 0,y=typeof d=="string"&&d.trim().length===0?void 0:d??void 0,C={id:String(n),name:v,owner:i!=null?String(i):void 0,ownerUsername:c,isFavorite:!!x,isPublic:!!I,createdAt:m,updatedAt:f,previewImage:r,backgroundColor:y,stats:{}},u=t.Canvas_Data??t.canvas_Data;let g;if(t.canvasDataDetails?.elements!=null)g={elements:t.canvasDataDetails.elements};else if(typeof u=="string")try{g=JSON.parse(u)}catch{g=void 0}else u&&typeof u=="object"&&(g=u);const o=g?.Elements??g?.elements??[],a=(Array.isArray(o)?o:[]).map(l=>O(l)).filter(l=>l!=null);return{meta:C,elements:a}}catch{return L(e)}}async function G(e,t,n){try{const i={ID_Canvas:Number(e),Canvas_Name:t.name,Canvas_Data:{Version:"1",ExportedAt:new Date().toISOString(),Elements:M(n)},Visibility:t.isPublic,Favorite:t.isFavorite,Background_Image:t.previewImage??null,Background_Color:t.backgroundColor??null},s=await S("/api/auth/canvas",{method:"PUT",body:i});return{...t,id:String(s||e)}}catch{return{...D(e,t.name??"Untitled"),...t}}}async function V(e){const t={Canvas_Name:e||"Untitled",Background_Image:null,Background_Color:null,Created_At:new Date().toISOString()},n={"Content-Type":"application/json"},i=E();i&&(n.Authorization=`Bearer ${i}`);const s=await fetch(`${N}/api/auth/canvas`,{method:"POST",headers:n,body:JSON.stringify(t)}),c=(await s.text()).trim();if(!s.ok)throw new Error(c||s.statusText);let v=null;try{const m=JSON.parse(c),f=m?.id??m?.ID_Canvas;f!=null&&Number.isFinite(Number(f))&&(v=Number(f))}catch{}if(v==null){const m=Number(c);Number.isFinite(m)&&(v=m)}if(v==null||!Number.isFinite(v))throw new Error(`Create canvas returned invalid id: '${c}'`);return D(String(v),e||"Untitled")}async function $(e){try{const t={ID_Canvas:Number(e)};await S("/api/auth/canvas",{method:"DELETE",body:t})}catch{}}function D(e,t){const n=new Date().toISOString();return{id:e,name:t,isFavorite:!1,isPublic:!1,updatedAt:n,createdAt:n,stats:{elementsCount:0}}}function U(){const e=new Date().toISOString();return[{id:"c-demo-1",name:"My First Board",isFavorite:!0,isPublic:!1,updatedAt:e,createdAt:e,previewImage:void 0,stats:{elementsCount:4,lastOpenedAt:e}},{id:"c-demo-2",name:"Study Plan",isFavorite:!1,isPublic:!0,updatedAt:e,createdAt:e,stats:{elementsCount:8}},{id:"c-demo-3",name:"Career Goals",isFavorite:!0,isPublic:!1,updatedAt:e,createdAt:e,stats:{elementsCount:6}}]}function L(e){return{meta:{...U().find(i=>i.id===e)??{...D(e,"Untitled"),id:e},id:e},elements:[]}}const X=T("canvas",()=>{const e=_([]),t=_([]),n=_(new Set),i=_([]),s=_(null),c=h(()=>e.value.map(o=>({...o,isFavorite:n.value.has(o.id)}))),v=h(()=>c.value.filter(o=>o.isFavorite)),m=h(()=>{const o=new Map(e.value.map(a=>[a.id,a]));return i.value.map(a=>o.get(a)).filter(Boolean).map(a=>({...a,isFavorite:n.value.has(a.id)}))});async function f(){const o=await j(),a=A(),l=a.user?.id,b=a.user?.username;e.value=o.map(w=>w.owner&&l&&String(w.owner)===String(l)&&b?{...w,ownerUsername:b}:w),n.value=new Set(e.value.filter(w=>w.isFavorite).map(w=>w.id))}async function I(){t.value=await z()}async function x(o){const a=await R(o);return a&&(s.value=a,i.value.includes(o)||(i.value=[o,...i.value.slice(0,9)])),a}async function p(o){s.value=null;let a=await V(o);const l=A();return l.user?.id&&(a={...a,owner:l.user.id}),l.user?.username&&(a={...a,ownerUsername:l.user.username}),e.value=[a,...e.value],s.value={meta:a,elements:[]},a}async function d(){if(!s.value)return;const{meta:o,elements:a}=s.value,l=await G(o.id,o,a),b=e.value.findIndex(w=>w.id===o.id);b>=0&&(e.value[b]={...e.value[b],...l}),s.value={...s.value,meta:{...o,...l}}}function r(o){s.value&&(s.value={...s.value,elements:o})}function y(o){s.value&&(s.value={...s.value,meta:{...s.value.meta,...o}})}function C(o){const a=new Set(n.value);a.has(o)?a.delete(o):a.add(o),n.value=a}function u(){s.value=null}async function g(o){await $(o),e.value=e.value.filter(a=>a.id!==o),t.value=t.value.filter(a=>a.id!==o),i.value=i.value.filter(a=>a!==o),s.value?.meta?.id===o&&(s.value=null)}return{allCanvases:e,publicCanvases:t,favoriteIds:n,recentIds:i,currentCanvas:s,favoriteCanvases:v,myCanvases:c,recentCanvases:m,loadCanvases:f,loadPublicCanvases:I,loadCanvas:x,createCanvas:p,saveCurrentCanvas:d,setCurrentElements:r,setCurrentMeta:y,toggleFavorite:C,clearCurrentCanvas:u,deleteCanvas:g}});export{X as u};
