const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Ua_Sh-XP.js","assets/ColorSet-BOh1LuAF.js","assets/Theme-B_KJklAe.js","assets/Scrollbar-DwA-abUg.js","assets/Slice-BJKWUNC6.js","assets/xy-rccMu8v9.js","assets/percent-DggLcHyk.js","assets/Animated-CBWNyxqE.js"])))=>i.map(i=>d[i]);
import{C as B,r as f,d as N,p as z,i as F,J as U,K as W,x as $,j,c as m,a as l,z as G,w as R,k as L,b as V,n as X,o as v,t as u,G as H,L as k,_ as J}from"./index-CLJoXIYq.js";import{M as b}from"./MstCard-ZHt_oOOv.js";import{e as K,a as q,c as Q}from"./user.service-DFFD7ZRQ.js";import{u as Z}from"./canvas.store-D4xSYhpa.js";const ee=B("user",()=>{const C=f(null);async function P(){return C.value=await K(),C.value}return{profile:C,loadProfile:P}}),te={class:"mst-profile"},se={class:"mst-profile__name"},ae={class:"mst-profile__email"},le={key:0,class:"mst-profile__bio"},oe={key:0,class:"mst-profile__loading"},ne={key:1,class:"mst-profile__charts"},re={key:0,class:"mst-profile__chart-wrap"},ie={key:1,class:"mst-profile__stats-list"},ce={class:"mst-profile__stats"},ue={class:"mst-profile__chart-wrap"},de={class:"mst-profile__stats"},ve={key:1,class:"mst-profile__empty"},me=N({__name:"ProfileView",setup(C){const P=z(),E=ee(),g=Z(),y=f(!0),n=f({conversations:0,messages:0,aiConversations:0,aiMessages:0,canvases:0,canvasElements:0}),w=f([]),A=f(!1),D=f(null),M=f(null);let p=null,_=null;function S(s){const e=new Date(s);return e.setHours(0,0,0,0),e.getTime()}F(async()=>{await E.loadProfile(),await g.loadCanvases(),y.value=!0;try{const[s,e]=await Promise.all([q(),U()]);n.value.conversations=s.length,n.value.aiConversations=e.length;const c=await Promise.all(s.map(t=>Q(t.id)));n.value.messages=c.flat().length;const a=await Promise.all(e.map(t=>W(t.id)));n.value.aiMessages=a.flat().length;const i=g.myCanvases;n.value.canvases=i.length,n.value.canvasElements=i.reduce((t,o)=>t+(o.stats?.elementsCount??0),0);const r=new Map;for(const t of c)for(const o of t)if(o.createdAt){const d=S(o.createdAt);r.set(d,(r.get(d)??0)+1)}for(const t of i){if(t.createdAt){const o=S(t.createdAt);r.set(o,(r.get(o)??0)+1)}if(t.updatedAt&&t.updatedAt!==t.createdAt){const o=S(t.updatedAt);r.set(o,(r.get(o)??0)+1)}}w.value=[...r.entries()].map(([t,o])=>({date:t,value:o})).sort((t,o)=>t.date-o.date),A.value=w.value.length>0}catch{n.value={conversations:0,messages:0,aiConversations:0,aiMessages:0,canvases:g.myCanvases.length,canvasElements:g.myCanvases.reduce((s,e)=>s+(e.stats?.elementsCount??0),0)},A.value=!1}finally{y.value=!1}});async function T(){const[s,e,c,a]=await Promise.all([k(()=>import("./index-Ua_Sh-XP.js"),__vite__mapDeps([0,1,2,3,4])),k(()=>import("./xy-rccMu8v9.js"),__vite__mapDeps([5,2,1,3])),k(()=>import("./percent-DggLcHyk.js"),__vite__mapDeps([6,1,2,4])),k(()=>import("./Animated-CBWNyxqE.js"),__vite__mapDeps([7,2]))]),i=s.default??s,r=e.default??e,t=c.default??c,d=a.default??a;return{am5:i,am5xy:r,am5percent:t,am5themes_Animated:d}}$(()=>[y.value,n.value,w.value,A.value],async()=>{y.value||(await H(),M.value&&await O(),A.value&&D.value&&await Y())},{immediate:!0});async function Y(){if(!D.value||w.value.length===0)return;p&&(p.dispose(),p=null);const{am5:s,am5xy:e,am5themes_Animated:c}=await T(),a=s.Root.new(D.value);a.setThemes([c.new(a)]);const i=a.container.children.push(e.XYChart.new(a,{panX:!0,panY:!1,wheelX:"panX",wheelY:"none",layout:a.verticalLayout})),r=i.xAxes.push(e.DateAxis.new(a,{baseInterval:{timeUnit:"day",count:1},renderer:e.AxisRendererX.new(a,{})})),t=i.yAxes.push(e.ValueAxis.new(a,{renderer:e.AxisRendererY.new(a,{})})),o=i.series.push(e.LineSeries.new(a,{name:"Activity",xAxis:r,yAxis:t,valueYField:"value",valueXField:"date"}));o.strokes.template.setAll({strokeWidth:2}),o.fills.template.setAll({fillOpacity:.3,visible:!0}),o.data.setAll(w.value),i.set("cursor",e.XYCursor.new(a,{behavior:"zoomX"})),p=a}async function O(){if(!M.value)return;_&&(_.dispose(),_=null);const{am5:s,am5percent:e,am5themes_Animated:c}=await T(),a=s.Root.new(M.value);a.setThemes([c.new(a)]);const i=a.container.children.push(e.PieChart.new(a,{radius:s.percent(90),innerRadius:s.percent(50),layout:a.verticalLayout})),r=[{category:"Chat",value:n.value.conversations+n.value.messages,color:s.color("#3b82f6")},{category:"AI",value:n.value.aiConversations+n.value.aiMessages,color:s.color("#44d7ff")},{category:"Canvas",value:n.value.canvases+n.value.canvasElements,color:s.color("#22c55e")}].filter(d=>d.value>0);r.length===0&&r.push({category:"No activity",value:1,color:s.color("#94a3b8")});const t=i.series.push(e.PieSeries.new(a,{valueField:"value",categoryField:"category"}));t.slices.template.setAll({cornerRadius:4,strokeWidth:2,stroke:s.color("#fff")}),t.labels.template.setAll({fontSize:10}),t.data.setAll(r),i.children.push(s.Legend.new(a,{centerX:s.percent(50),x:s.percent(50),layout:a.horizontalLayout})).data.setAll(t.dataItems),t.appear(),i.appear(),_=a}j(()=>{p?.dispose(),p=null,_?.dispose(),_=null});const h=X(()=>P.user??E.profile),x=X(()=>{const s=g.myCanvases,e=s.length;if(e===0)return{count:0,oldestDate:null,newestDate:null};const c=s.flatMap(r=>{const t=r.createdAt?new Date(r.createdAt).getTime():null,o=r.updatedAt?new Date(r.updatedAt).getTime():null;return[t,o].filter(d=>d!=null)}),a=Math.min(...c),i=Math.max(...c);return{count:e,oldestDate:new Date(a),newestDate:new Date(i)}});function I(s){return s.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}return(s,e)=>(v(),m("div",te,[e[6]||(e[6]=l("header",{class:"mst-profile__header"},[l("h1",{class:"mst-profile__title"},"Profile"),l("p",{class:"mst-profile__subtitle"},"Your account and stats.")],-1)),h.value?(v(),G(b,{key:0,class:"mst-profile__card"},{default:R(()=>[l("h3",se,u(h.value.username),1),l("p",ae,u(h.value.email),1),h.value.bio?(v(),m("p",le,u(h.value.bio),1)):L("",!0)]),_:1})):L("",!0),V(b,{class:"mst-profile__card"},{default:R(()=>[e[4]||(e[4]=l("h3",{class:"mst-profile__stats-title"},"Statistics",-1)),y.value?(v(),m("p",oe,"Loading stats…")):(v(),m("div",ne,[A.value?(v(),m("div",re,[e[0]||(e[0]=l("h4",{class:"mst-profile__chart-title"},"Activity over time",-1)),e[1]||(e[1]=l("p",{class:"mst-profile__chart-desc"}," Messages sent and canvases created or updated, grouped by day. ",-1)),l("div",{ref_key:"timeChartRef",ref:D,class:"mst-profile__chart"},null,512)])):(v(),m("div",ie,[e[2]||(e[2]=l("h4",{class:"mst-profile__chart-title"},"Stats",-1)),l("ul",ce,[l("li",null,"Conversations: "+u(n.value.conversations),1),l("li",null,"Messages: "+u(n.value.messages),1),l("li",null,"AI conversations: "+u(n.value.aiConversations),1),l("li",null,"AI messages: "+u(n.value.aiMessages),1),l("li",null,"Canvases: "+u(n.value.canvases),1),l("li",null,"Canvas elements: "+u(n.value.canvasElements),1)])])),l("div",ue,[e[3]||(e[3]=l("h4",{class:"mst-profile__chart-title"},"Activity breakdown",-1)),l("div",{ref_key:"pieChartRef",ref:M,class:"mst-profile__chart mst-profile__chart--pie"},null,512)])]))]),_:1}),V(b,{class:"mst-profile__card"},{default:R(()=>[e[5]||(e[5]=l("h3",{class:"mst-profile__stats-title"},"Canvas activity",-1)),l("ul",de,[l("li",null,"Canvases: "+u(n.value.canvases),1),l("li",null,"Oldest canvas: "+u(x.value.oldestDate?I(x.value.oldestDate):"—"),1),l("li",null,"Newest canvas: "+u(x.value.newestDate?I(x.value.newestDate):"—"),1)])]),_:1}),h.value?L("",!0):(v(),m("p",ve,"Loading profile…"))]))}}),ge=J(me,[["__scopeId","data-v-e618c180"]]);export{ge as default};
