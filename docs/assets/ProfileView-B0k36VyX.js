import{u as N,g as F,d as z,e as P,_ as U}from"./index-DfVD50Wy.js";import{M as b}from"./MstCard-DOMq7TXY.js";import{d as W,r as f,a as $,s as q,w as H,x as J,b as p,h as l,g as j,q as E,k as L,p as X,c as Y,o as v,t as u,J as G}from"./vendor-CYnaoYaV.js";import{e as K,a as Q,c as Z}from"./user.service-Qi1RfXeL.js";import{u as ee}from"./canvas.store-DR8ZLaIk.js";const te=W("user",()=>{const D=f(null);async function S(){return D.value=await K(),D.value}return{profile:D,loadProfile:S}}),se={class:"mst-profile"},ae={class:"mst-profile__name"},le={class:"mst-profile__email"},oe={key:0,class:"mst-profile__bio"},ne={key:0,class:"mst-profile__loading"},re={key:1,class:"mst-profile__charts"},ie={key:0,class:"mst-profile__chart-wrap"},ce={key:1,class:"mst-profile__stats-list"},ue={class:"mst-profile__stats"},de={class:"mst-profile__chart-wrap"},ve={class:"mst-profile__stats"},me={key:1,class:"mst-profile__empty"},pe=$({__name:"ProfileView",setup(D){const S=N(),T=te(),y=ee(),w=f(!0),n=f({conversations:0,messages:0,aiConversations:0,aiMessages:0,canvases:0,canvasElements:0}),A=f([]),C=f(!1),x=f(null),M=f(null);let _=null,h=null;function R(s){const e=new Date(s);return e.setHours(0,0,0,0),e.getTime()}q(async()=>{await T.loadProfile(),await y.loadCanvases(),w.value=!0;try{const[s,e]=await Promise.all([Q(),F()]);n.value.conversations=s.length,n.value.aiConversations=e.length;const c=await Promise.all(s.map(t=>Z(t.id)));n.value.messages=c.flat().length;const a=await Promise.all(e.map(t=>z(t.id)));n.value.aiMessages=a.flat().length;const i=y.myCanvases;n.value.canvases=i.length,n.value.canvasElements=i.reduce((t,o)=>t+(o.stats?.elementsCount??0),0);const r=new Map;for(const t of c)for(const o of t)if(o.createdAt){const d=R(o.createdAt);r.set(d,(r.get(d)??0)+1)}for(const t of i){if(t.createdAt){const o=R(t.createdAt);r.set(o,(r.get(o)??0)+1)}if(t.updatedAt&&t.updatedAt!==t.createdAt){const o=R(t.updatedAt);r.set(o,(r.get(o)??0)+1)}}A.value=[...r.entries()].map(([t,o])=>({date:t,value:o})).sort((t,o)=>t.date-o.date),C.value=A.value.length>0}catch{n.value={conversations:0,messages:0,aiConversations:0,aiMessages:0,canvases:y.myCanvases.length,canvasElements:y.myCanvases.reduce((s,e)=>s+(e.stats?.elementsCount??0),0)},C.value=!1}finally{w.value=!1}});async function I(){const[s,e,c,a]=await Promise.all([P(()=>import("./amcharts-DuSt3dTx.js").then(m=>m.i),[]),P(()=>import("./amcharts-DuSt3dTx.js").then(m=>m.x),[]),P(()=>import("./amcharts-DuSt3dTx.js").then(m=>m.p),[]),P(()=>import("./amcharts-DuSt3dTx.js").then(m=>m.A),[])]),i=s.default??s,r=e.default??e,t=c.default??c,d=a.default??a;return{am5:i,am5xy:r,am5percent:t,am5themes_Animated:d}}H(()=>[w.value,n.value,A.value,C.value],async()=>{w.value||(await G(),M.value&&await B(),C.value&&x.value&&await O())},{immediate:!0});async function O(){if(!x.value||A.value.length===0)return;_&&(_.dispose(),_=null);const{am5:s,am5xy:e,am5themes_Animated:c}=await I(),a=s.Root.new(x.value);a.setThemes([c.new(a)]);const i=a.container.children.push(e.XYChart.new(a,{panX:!0,panY:!1,wheelX:"panX",wheelY:"none",layout:a.verticalLayout})),r=i.xAxes.push(e.DateAxis.new(a,{baseInterval:{timeUnit:"day",count:1},renderer:e.AxisRendererX.new(a,{})})),t=i.yAxes.push(e.ValueAxis.new(a,{renderer:e.AxisRendererY.new(a,{})})),o=i.series.push(e.LineSeries.new(a,{name:"Activity",xAxis:r,yAxis:t,valueYField:"value",valueXField:"date"}));o.strokes.template.setAll({strokeWidth:2}),o.fills.template.setAll({fillOpacity:.3,visible:!0}),o.data.setAll(A.value),i.set("cursor",e.XYCursor.new(a,{behavior:"zoomX"})),_=a}async function B(){if(!M.value)return;h&&(h.dispose(),h=null);const{am5:s,am5percent:e,am5themes_Animated:c}=await I(),a=s.Root.new(M.value);a.setThemes([c.new(a)]);const i=a.container.children.push(e.PieChart.new(a,{radius:s.percent(90),innerRadius:s.percent(50),layout:a.verticalLayout})),r=[{category:"Chat",value:n.value.conversations+n.value.messages,color:s.color("#3b82f6")},{category:"AI",value:n.value.aiConversations+n.value.aiMessages,color:s.color("#44d7ff")},{category:"Canvas",value:n.value.canvases+n.value.canvasElements,color:s.color("#22c55e")}].filter(d=>d.value>0);r.length===0&&r.push({category:"No activity",value:1,color:s.color("#94a3b8")});const t=i.series.push(e.PieSeries.new(a,{valueField:"value",categoryField:"category"}));t.slices.template.setAll({cornerRadius:4,strokeWidth:2,stroke:s.color("#fff")}),t.labels.template.setAll({fontSize:10}),t.data.setAll(r),i.children.push(s.Legend.new(a,{centerX:s.percent(50),x:s.percent(50),layout:a.horizontalLayout})).data.setAll(t.dataItems),t.appear(),i.appear(),h=a}J(()=>{_?.dispose(),_=null,h?.dispose(),h=null});const g=Y(()=>S.user??T.profile),k=Y(()=>{const s=y.myCanvases,e=s.length;if(e===0)return{count:0,oldestDate:null,newestDate:null};const c=s.flatMap(r=>{const t=r.createdAt?new Date(r.createdAt).getTime():null,o=r.updatedAt?new Date(r.updatedAt).getTime():null;return[t,o].filter(d=>d!=null)}),a=Math.min(...c),i=Math.max(...c);return{count:e,oldestDate:new Date(a),newestDate:new Date(i)}});function V(s){return s.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}return(s,e)=>(v(),p("div",se,[e[6]||(e[6]=l("header",{class:"mst-profile__header"},[l("h1",{class:"mst-profile__title"},"Profile"),l("p",{class:"mst-profile__subtitle"},"Your account and stats.")],-1)),g.value?(v(),j(b,{key:0,class:"mst-profile__card"},{default:E(()=>[l("h3",ae,u(g.value.username),1),l("p",le,u(g.value.email),1),g.value.bio?(v(),p("p",oe,u(g.value.bio),1)):L("",!0)]),_:1})):L("",!0),X(b,{class:"mst-profile__card"},{default:E(()=>[e[4]||(e[4]=l("h3",{class:"mst-profile__stats-title"},"Statistics",-1)),w.value?(v(),p("p",ne,"Loading stats…")):(v(),p("div",re,[C.value?(v(),p("div",ie,[e[0]||(e[0]=l("h4",{class:"mst-profile__chart-title"},"Activity over time",-1)),e[1]||(e[1]=l("p",{class:"mst-profile__chart-desc"}," Messages sent and canvases created or updated, grouped by day. ",-1)),l("div",{ref_key:"timeChartRef",ref:x,class:"mst-profile__chart"},null,512)])):(v(),p("div",ce,[e[2]||(e[2]=l("h4",{class:"mst-profile__chart-title"},"Stats",-1)),l("ul",ue,[l("li",null,"Conversations: "+u(n.value.conversations),1),l("li",null,"Messages: "+u(n.value.messages),1),l("li",null,"AI conversations: "+u(n.value.aiConversations),1),l("li",null,"AI messages: "+u(n.value.aiMessages),1),l("li",null,"Canvases: "+u(n.value.canvases),1),l("li",null,"Canvas elements: "+u(n.value.canvasElements),1)])])),l("div",de,[e[3]||(e[3]=l("h4",{class:"mst-profile__chart-title"},"Activity breakdown",-1)),l("div",{ref_key:"pieChartRef",ref:M,class:"mst-profile__chart mst-profile__chart--pie"},null,512)])]))]),_:1}),X(b,{class:"mst-profile__card"},{default:E(()=>[e[5]||(e[5]=l("h3",{class:"mst-profile__stats-title"},"Canvas activity",-1)),l("ul",ve,[l("li",null,"Canvases: "+u(n.value.canvases),1),l("li",null,"Oldest canvas: "+u(k.value.oldestDate?V(k.value.oldestDate):"—"),1),l("li",null,"Newest canvas: "+u(k.value.newestDate?V(k.value.newestDate):"—"),1)])]),_:1}),g.value?L("",!0):(v(),p("p",me,"Loading profile…"))]))}}),we=U(pe,[["__scopeId","data-v-e618c180"]]);export{we as default};
